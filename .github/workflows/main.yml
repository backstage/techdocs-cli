name: Main Build

on:
  push:
    branches: [main]

env:
  package: "@techdocs/cli"

jobs:
  precheck:
    runs-on: ubuntu-latest
    outputs:
      isPublished: ${{ steps.npm.outputs.view }}
    steps:
    - uses: actions/checkout@v2
    - id: npm
      run: |
        CURRENT_VERSION=$(cat packages/techdocs-cli/package.json \
          | grep version \
          | head -1 \
          | awk -F: '{ print $2 }' \
          | sed 's/[",]//g' \
          | tr -d '[[:space:]]')
        NPM_VIEW=$(npm view ${{ env.package }}@$CURRENT_VERSION --json)
        echo "::set-output name=view::$NPM_VIEW"

  release:
    runs-on: ubuntu-latest
    needs: precheck
    if: ${{ !needs.precheck.outputs.isPublished }}
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: 12.x
          registry-url: https://registry.npmjs.org/ # Needed for auth
      - run: yarn install --frozen-lockfile
      - run: yarn tsc
      - run: yarn build
      - name: Publish
        run: yarn workspace ${{ env.package }} publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
